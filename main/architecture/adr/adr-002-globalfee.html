<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-architecture/adr/adr-002-globalfee" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">ADR 002: Globalfee Module [DEPRECATED] | Cosmos Hub</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hub.cosmos.network/img/banner.jpg"><meta data-rh="true" name="twitter:image" content="https://hub.cosmos.network/img/banner.jpg"><meta data-rh="true" property="og:url" content="https://hub.cosmos.network/main/architecture/adr/adr-002-globalfee"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ADR 002: Globalfee Module [DEPRECATED] | Cosmos Hub"><meta data-rh="true" name="description" content="Changelog"><meta data-rh="true" property="og:description" content="Changelog"><link data-rh="true" rel="icon" href="/img/hub.svg"><link data-rh="true" rel="canonical" href="https://hub.cosmos.network/main/architecture/adr/adr-002-globalfee"><link data-rh="true" rel="alternate" href="https://hub.cosmos.network/main/architecture/adr/adr-002-globalfee" hreflang="en"><link data-rh="true" rel="alternate" href="https://hub.cosmos.network/main/architecture/adr/adr-002-globalfee" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EB7MEE3TJ1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-EB7MEE3TJ1",{anonymize_ip:!0})</script>






<script src="https://kit.fontawesome.com/401fb1e734.js" crossorigin="anonymous"></script><link rel="stylesheet" href="/assets/css/styles.8239f9bf.css">
<script src="/assets/js/runtime~main.356db4b3.js" defer="defer"></script>
<script src="/assets/js/main.842277d5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_gu5v" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/hub.svg" alt="Cosmos Hub Logo" class="themedComponent_ZRzL themedComponent--light_dGsa"><img src="/img/hub.svg" alt="Cosmos Hub Logo" class="themedComponent_ZRzL themedComponent--dark_pzCA"></div><b class="navbar__title text--truncate">Cosmos Hub</b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/main/architecture/adr/adr-002-globalfee">Latest</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/main/architecture/adr/adr-002-globalfee">Latest</a></li><li><a href="https://github.com/cosmos/gaia/tree/legacy-docs" target="_blank" rel="noopener noreferrer" class="dropdown__link">Archive<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a href="https://github.com/cosmos/gaia" target="_blank" rel="noopener noreferrer" class="dropdown__link"><i class="fa-fw fa-brands fa-github"></i> Github</a></li><li><a href="https://twitter.com/cosmoshub" target="_blank" rel="noopener noreferrer" class="dropdown__link"><i class="fa-fw fa-brands fa-twitter"></i> Twitter</a></li><li><a href="https://discord.gg/interchain" target="_blank" rel="noopener noreferrer" class="dropdown__link"><i class="fa-fw fa-brands fa-discord"></i> Discord</a></li><li><a href="https://forum.cosmos.network/" target="_blank" rel="noopener noreferrer" class="dropdown__link"><i class="fa-fw fa-regular fa-comments"></i> Forum</a></li><li><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="dropdown__link"><i class="fa-fw fa-brands fa-reddit"></i> Reddit</a></li><li><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="dropdown__link"><i class="fa-fw fa-brands fa-youtube"></i> YouTube</a></li></ul></div><div class="toggle_kWbt colorModeToggle_GwZs"><button class="clean-btn toggleButton_fOL9 toggleButtonDisabled_STpu" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_DCeJ"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_DFgp"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_IP3a"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_IbdI"><div class="docsWrapper_JGIH"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_SdI4" type="button"></button><div class="docRoot_eRbX"><aside class="theme-doc-sidebar-container docSidebarContainer_Ta75"><div class="sidebarViewport_fgog"><div class="sidebar_oDHW"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_vPEQ"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/main">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/main/getting-started">Getting Started</a><button aria-label="Expand sidebar category &#x27;Getting Started&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/main/hub-tutorials">Guides</a><button aria-label="Expand sidebar category &#x27;Guides&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/main/delegators">Delegators</a><button aria-label="Expand sidebar category &#x27;Delegators&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/main/validators">Validators</a><button aria-label="Expand sidebar category &#x27;Validators&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/main/governance">Governance</a><button aria-label="Expand sidebar category &#x27;Governance&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/main/interchain-security">Interchain Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/main/resources">Resources</a><button aria-label="Expand sidebar category &#x27;Resources&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/main/architecture">ADRs</a><button aria-label="Collapse sidebar category &#x27;ADRs&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/main/architecture/adr/PROCESS">Current ADR&#x27;s</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/main/architecture/adr/PROCESS">ADR Creation Process</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/main/architecture/adr">README</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/main/architecture/adr/adr-001-interchain-accounts">adr-001-interchain-accounts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/main/architecture/adr/adr-002-globalfee">ADR 002: Globalfee Module [DEPRECATED]</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/main/architecture/adr/adr-003-ica-controller">ADR 003: Interchain Accounts Controller Module</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/main/architecture/templates/adr-template">ADR Templates</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/main/architecture/PROCESS">ADR Creation Process</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/main/modules">Gaia Modules</a><button aria-label="Expand sidebar category &#x27;Gaia Modules&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_Cq4q"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_eHqP"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_lg0V"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_nDJs"><div class="docItemContainer_OGiL"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_k3Z9" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_JACu"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/main/architecture"><span itemprop="name">ADRs</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Current ADR&#x27;s</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ADR 002: Globalfee Module [DEPRECATED]</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_QCOD theme-doc-toc-mobile tocMobile_N0YI"><button type="button" class="clean-btn tocCollapsibleButton_pHwF">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ADR 002: Globalfee Module [DEPRECATED]</h1></header>
<h2 class="anchor anchorWithStickyNavbar_FNw8" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog">​</a></h2>
<ul>
<li>2023-06-12: Initial Draft</li>
<li>2024-06-06: Change status to deprecated</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_FNw8" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2>
<p>Deprecated</p>
<h2 class="anchor anchorWithStickyNavbar_FNw8" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2>
<p>The globalfee module was created to manage a parameter called <code>MinimumGasPricesParam</code>, which sets a network-wide minimum fee requirement. The intention was to stop random denominations from entering fee collections and to reduce the time validators take to check a long list of transaction fees. To address scenarios where no fee payment is required but the denominations for volunteered paid fees are still restricted, the zero coins was introduced to serve as a means of limiting the denoms. Nevertheless, the initial version of the globalfee module had some issues:</p>
<ul>
<li>
<p>In the globalfee module, several Cosmos SDK coins methods were redefined because of the allowance of zero-value coins in the <code>MinimumGasPricesParam</code>. The <code>MinimumGasPricesParam</code> is of <code>sdk.DecCoins</code> type. In the Cosmos SDK, <code>sdk.DecCoins</code> are <a href="https://github.com/cosmos/cosmos-sdk/blob/67f04e629623d4691c4b2e48806f7793a3aa211e/types/dec_coin.go#L160-L177" target="_blank" rel="noopener noreferrer">sanitized</a> to remove zero-value coins. As a result, several methods from <code>sdk.Coins</code> were <a href="https://github.com/cosmos/gaia/blob/890ab3aa2e5788537b0d2ebc9bafdc968340e0e5/x/globalfee/ante/fee_utils.go#L46-L104" target="_blank" rel="noopener noreferrer">redefined in the Gaia fee antehandler</a>.</p>
</li>
<li>
<p><code>BypassMinFeeMsgTypes</code> exists in <code>app.toml</code>, which means each node can define its own value. Thus, it&#x27;s not clear whether a transaction containing bypass-messages will be exempted from paying a fee.</p>
</li>
<li>
<p>The fee check logic is only executed in <code>CheckTx</code>. This could enable malicious validators to change the fee check code and propose transactions that do not meet the fee requirement.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_FNw8" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2>
<p>To fix these problems, the following changes are added to the globalfee module:</p>
<ul>
<li><strong>ZeroCoins in <code>MinimumGasPricesParam</code>:</strong><br>
<!-- -->Refactor the fee check logics, in order to use the Cosmos SDK coins&#x27; methods instead of the redefined methods.</li>
<li><strong>Bypass Message Types:</strong><br>
<code>BypassMinFeeMsgTypes</code> is refactored to be a param of the globalfee module, in order to make the bypass messages deterministic.</li>
<li><strong>Check Fees in <code>DeliverTx</code>:</strong><br>
<!-- -->The fee check is factored to executed in both <code>DeliverTx</code> and <code>CheckTx</code>. This is to prevent malicious validators from changing the fee check logic and allowing any transactions to pass fee check. As a consequence, <code>MinimumGasPricesParam</code> is introduced as a globalfee param.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_FNw8" id="zerocoins-in-minimumgaspricesparam">ZeroCoins in <code>MinimumGasPricesParam</code><a href="#zerocoins-in-minimumgaspricesparam" class="hash-link" aria-label="Direct link to zerocoins-in-minimumgaspricesparam" title="Direct link to zerocoins-in-minimumgaspricesparam">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_FNw8" id="coins-split">Coins Split<a href="#coins-split" class="hash-link" aria-label="Direct link to Coins Split" title="Direct link to Coins Split">​</a></h4>
<p><code>CombinedFeeRequirement</code> refers to the fee requirement that takes into account both <code>globalFees</code> (<code>MinimumGasPricesParam</code> in the globalfee module) and <code>localFees</code> (<code>minimum-gas-prices</code> in <code>app.toml</code>). This requirement is calculated as the maximum value between <code>globalFees</code> and <code>localFees</code> for denomination exists <code>globalFees</code>.
The allowance of zero coins in the <code>MinimumGasPricesParam</code> within the globalfee module implies that <code>CombinedFeeRequirement(globalFees, localFees)</code> also permits zero coins. Therefore, the <code>CombinedFeeRequirement</code> doesn&#x27;t meet the requirements of certain <code>sdk.Coins</code> methods. For instance, the <code>DenomsSubsetOf</code> method requires coins that do not contain zero coins.</p>
<p>To address this issue, the <code>CombinedFeeRequirement</code> and <code>feeCoins</code> are split as shown in the chart below.</p>
<div class="language-mermaid codeBlockContainer_aalF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_MHx8"><pre tabindex="0" class="prism-code language-mermaid codeBlock_zHgq thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_RjmQ"><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title: Fee Requirements and Fee Splits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flowchart TD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subgraph feeReq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A[CombinedFeeRequirement]--&gt;B[/Split zero/nonzero coins/]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    B--&gt;|zero coins| C[zeroCoinFeesDenomReq];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	B--&gt;|nonzero coins| D[nonzeroCoinFeesDenomReq];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	subgraph feeCoin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	E[feeCoins]--&gt;F[/Split by the denoms in zero/nonzero CoinFeesDenomReq/]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    F--&gt;|denoms in zeroCoinFeesDenomReq set| G[feeCoinsZeroDenom]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    F--&gt;|denoms in nonzeroCoinFeesDenomReq set| H[feeCoinsNonZeroDenom]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	end</span><br></span></code></pre><div class="buttonGroup_Sd8_"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_LnQD" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_t3l1"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_IiZV"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>CombinedFeeRequirement</code> is split into zero and non-zero coins, forming <code>nonZeroCoinFeesReq</code> and <code>zeroCoinFeesDenomReq</code>. Similarly, the paid fees (feeCoins) are split into <code>feeCoinsNonZeroDenom</code> and <code>feeCoinsZeroDenom</code>, based on the denominations of <code>nonZeroCoinFeesReq</code> and <code>zeroCoinFeesDenomReq</code> as shown in the following code snippet.</p>
<div class="language-go codeBlockContainer_aalF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_MHx8"><pre tabindex="0" class="prism-code language-go codeBlock_zHgq thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_RjmQ"><span class="token-line" style="color:#393A34"><span class="token plain">	nonZeroCoinFeesReq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zeroCoinFeesDenomReq </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getNonZeroFees</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">feeRequired</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// feeCoinsNonZeroDenom contains non-zero denominations from the feeRequired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// feeCoinsNonZeroDenom is used to check if the fees meets the requirement imposed by nonZeroCoinFeesReq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// when feeCoins does not contain zero coins&#x27; denoms in feeRequired</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	feeCoinsNonZeroDenom</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> feeCoinsZeroDenom </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">splitCoinsByDenoms</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">feeCoins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zeroCoinFeesDenomReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_Sd8_"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_LnQD" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_t3l1"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_IiZV"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_FNw8" id="fee-checks">Fee Checks<a href="#fee-checks" class="hash-link" aria-label="Direct link to Fee Checks" title="Direct link to Fee Checks">​</a></h4>
<p>The Workflow of feeCheck is shown below:</p>
<div class="language-mermaid codeBlockContainer_aalF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_MHx8"><pre tabindex="0" class="prism-code language-mermaid codeBlock_zHgq thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_RjmQ"><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">title: Fee Check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flowchart TD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">A[feeCoinsNonZeroDenom]--&gt;B[/DenomsSubsetOf_nonZeroCoinFeesReq/];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B--&gt;|yes|C[is_bypass_msg];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B--&gt;|no|D((reject));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C--&gt;|yes|pass1((pass));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C--&gt;|no|D[/contain_zeroCoinFeesDenomReq_denom/];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D--&gt;|yes|pass2((pass));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">D--&gt;|no|E[/feeCoinsZeroDenom_nonEmpty/];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E--&gt;|yes|pass3((pass));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E--&gt;|no|F[/IsAnyGTE_nonZeroCoinFeesDenomReq/];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">F--&gt;|yes|pass4((pass));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">F--&gt;|no|reject2((reject));</span><br></span></code></pre><div class="buttonGroup_Sd8_"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_LnQD" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_t3l1"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_IiZV"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The split enable checking <code>feeCoinsNonZeroDenom</code> against <code>nonZeroCoinFeesReq</code>, and <code>feeCoinsZeroDenom</code> against
<code>zeroCoinFeesDenomReq</code> (as shown in the following code snippet). In the check of <code>feeCoinsNonZeroDenom</code> against <code>nonZeroCoinFeesReq</code>, the Cosmos SDK coins&#x27; methods can be used since zero coins are removed from the <code>nonZeroCoinFeesReq</code>, while in the check <code>feeCoinsZeroDenom</code> against <code>zeroCoinFeesDenomReq</code>, only denoms need to be checked.</p>
<p>Checking <code>feeCoinsNonZeroDenom</code> against <code>nonZeroCoinFeesReq</code>:</p>
<div class="language-go codeBlockContainer_aalF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_MHx8"><pre tabindex="0" class="prism-code language-go codeBlock_zHgq thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_RjmQ"><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">feeCoinsNonZeroDenom</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsAnyGTE</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nonZeroCoinFeesReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sdkerrors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wrapf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdkerrors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrInsufficientFee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;insufficient fees; got: %s required: %s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> feeCoins</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> feeRequired</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_Sd8_"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_LnQD" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_t3l1"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_IiZV"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is an example of how the coins split and checked in fee antehandler:</p>
<p><strong>assumption</strong>:</p>
<p><code>globalfee=[1photon, 0uatom, 1stake]</code> and <code>local min-gas-prices=[0.5stake]</code></p>
<p><strong>fee requirement</strong>:</p>
<p><code>combinedFeeRequirement=[1photon, 0uatom, 1stake]</code></p>
<p><strong>split fee requirement</strong>:</p>
<p>the <code>combinedFeeRequirement</code> into <code>nonZeroCoinFeesReq=[0uatom]</code>, and <code>nonZeroCoinFeesReq=[1photon, 1stake]</code></p>
<p><strong>split the paid fees</strong>:</p>
<p>if <code>paidFee=[1uatom, 0.5photon]</code>,
the <code>splitCoinsByDenoms</code> splits the paidFee into <code>feeCoinsZeroDenom=[1uatom]</code> (the same denom as zero coins in <code>combinedFeeRequirement</code>), and <code>feeCoinsNonZeroDenom=[0.5stake]</code>
then <code>feeCoinsZeroDenom=[1uatom]</code> is checked by <code>nonZeroCoinFeesReq=[1photon, 1stake]</code>.</p>
<p>Please note that <code>feeCoins</code> does not contain zero coins. The fee coins are split according to the denoms in <code>zeroCoinFeesDenomReq</code> or <code>nonZeroCoinFeesDenomReq</code>. If feeCoins contains coins not in both <code>zeroCoinFeesDenomReq</code> and <code>nonZeroCoinFeesDenomReq</code>, the transaction should be rejected. On the contrary, if feeCoins&#x27; denoms are in either <code>zeroCoinFeesDenomReq</code> or <code>nonZeroCoinFeesDenomReq</code>, and <code>len(zeroCoinFeesDenomReq)!=0</code>, the transaction can directly pass, otherwise, the fee amount need to be checked.</p>
<h3 class="anchor anchorWithStickyNavbar_FNw8" id="bypass-message-types">Bypass Message Types<a href="#bypass-message-types" class="hash-link" aria-label="Direct link to Bypass Message Types" title="Direct link to Bypass Message Types">​</a></h3>
<p><code>BypassMinFeeMsgTypes</code> was a setup in <code>config/app.toml</code> before the refactor. <code>BypassMinFeeMsgTypes</code> is refactored to be a param of the globalfee module to get a network level agreement. Correspondingly,<code>MaxTotalBypassMinFeeMsgGasUsage</code> is also introduced as a globalfee param.</p>
<h3 class="anchor anchorWithStickyNavbar_FNw8" id="fee-checks-in-delivertx">Fee Checks in <code>DeliverTx</code><a href="#fee-checks-in-delivertx" class="hash-link" aria-label="Direct link to fee-checks-in-delivertx" title="Direct link to fee-checks-in-delivertx">​</a></h3>
<p>Implementing fee checks within the <code>DeliverTx</code> function introduces a few requirements:</p>
<ul>
<li><strong>Deterministic Minimum Fee Requirement</strong>: For the <code>DeliverTx</code> process, it is essential to have a deterministic minimum fee requirement. In <code>CheckTx</code>, fee is checked by the <code>CombinedFeeRequirement(globalFees, localFees)</code>, which considers both <code>minimum-gas-prices</code> from <code>config/app.toml</code> and <code>MinimumGasPricesParam</code> from the globalfee Params (For more details, see <a href="https://github.com/cosmos/gaia/blob/v16.0.0/docs/docs/modules/globalfee.md" target="_blank" rel="noopener noreferrer">globalfee</a>). <code>CombinedFeeRequirement</code> contains non-deterministic part: <code>minimum-gas-prices</code> from <code>app.toml</code>. Therefore, <code>CombinedFeeRequirement</code> cannot be used in <code>DeliverTx</code>. In <code>DeliverTx</code>, only <code>MinimumGasPricesParam</code> in globalfee Params is used for fee verification. The code implementation is shown below.</li>
</ul>
<div class="language-go codeBlockContainer_aalF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_MHx8"><pre tabindex="0" class="prism-code language-go codeBlock_zHgq thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_RjmQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mfd FeeDecorator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetTxFeeRequired</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tx sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FeeTx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Coins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Get required global fee min gas prices</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Note that it should never be empty since its default value is set to coin={&quot;StakingBondDenom&quot;, 0}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	globalFees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> mfd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetGlobalFee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sdk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Coins</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// In DeliverTx, the global fee min gas prices are the only tx fee requirements.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsCheckTx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> globalFees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// In CheckTx mode, the local and global fee min gas prices are combined</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// to form the tx fee requirements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Get local minimum-gas-prices</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	localFees </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetMinGasPrice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetGas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Return combined fee requirements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CombinedFeeRequirement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalFees</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> localFees</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_Sd8_"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_LnQD" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_t3l1"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_IiZV"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p><strong>Deterministic Bypass Parameters</strong>: The decision of whether a message can bypass the minimum fee has to be deterministic as well. To ensure this, <code>BypassMinFeeMsgTypes</code> and <code>MaxTotalBypassMinFeeMsgGasUsage</code> parameters are moved to a persistent store.</p>
</li>
<li>
<p><strong>Module Initialization Order</strong>: The genutils module must be initialized before the globalfee module. This is due to the <code>DeliverGenTxs</code> in the genutils module, is called during <code>initGenesis</code>. This function executes <code>DeliverTx</code>, which subsequently calls the AnteHandle in FeeDecorator, triggering the fee check in <code>DeliverTx</code>.
To prevent the <code>DeliverGenTxs</code> go through a fee check, the initialization of the globalfee module should occur after the genutils module. This sequencing ensures that all necessary components are in place when the fee check occurs. See <a href="https://github.com/cosmos/gaia/issues/2489" target="_blank" rel="noopener noreferrer">Gaia Issue #2489</a> for more context.</p>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_FNw8" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_FNw8" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive">​</a></h3>
<p>This refactor results in code that is easier to maintain. It prevents malicious validators from escaping fee checks and make the bypass messages work at network level.</p>
<h3 class="anchor anchorWithStickyNavbar_FNw8" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative">​</a></h3>
<p>The introduction of FeeDecorator has replaced the usage of <code>MempoolFeeDecorator</code> in the Cosmos SDK. Currently, if both FeeDecorator and MempoolFeeDecorator are added to the AnteDecorator chain, it will result in redundant checks. However, there&#x27;s potential for FeeDecorator and MempoolFeeDecorator to become incompatible in the future, depending on updates to the Cosmos SDK.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/main/architecture/adr/adr-001-interchain-accounts"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">adr-001-interchain-accounts</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/main/architecture/adr/adr-003-ica-controller"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ADR 003: Interchain Accounts Controller Module</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_IS5x thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#zerocoins-in-minimumgaspricesparam" class="table-of-contents__link toc-highlight">ZeroCoins in <code>MinimumGasPricesParam</code></a></li><li><a href="#bypass-message-types" class="table-of-contents__link toc-highlight">Bypass Message Types</a></li><li><a href="#fee-checks-in-delivertx" class="table-of-contents__link toc-highlight">Fee Checks in <code>DeliverTx</code></a></li></ul></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cosmos.network"><img src="/img/logo-bw-inverse.svg" alt="Cosmos Logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.cosmos.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://docs.cometbft.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CometBFT<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://ibc.cosmos.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC-Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://cosmos.github.io/interchain-security/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Interchain Security<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://forum.cosmos.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/interchain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://reddit.com/r/cosmosnetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://blog.cosmos.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Social</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/cosmoshub" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/CosmosProject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cosmosproject" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_T11m"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">This website is maintained by Interchain Foundation & Informal Systems. The contents and opinions of this website are those of Interchain Foundation & Informal Systems.</div></div></div></footer></div>
</body>
</html>